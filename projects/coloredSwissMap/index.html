<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Colored swiss map</title>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">

	<style>
  #draggable { width: 124px; height: 124px; border-color: transparent; background-color: transparent; display: none;}
  </style>

	<script>
	$( function() {
		$( "#draggable" ).draggable();
	} );
	</script>

</head>
<body>

<div id="draggable" class="ui-widget-content">
  	<canvas width="124" height="124" id="canvas_picker"></canvas>
</div>

<img class="svg" src="img/cantons_swiss_default.svg"/>

<script type="text/javascript">

	var canvas = document.getElementById('canvas_picker').getContext('2d');

	var selectedCanton;

	// create an image object and get itâ€™s source
	var img = new Image();
	img.src = 'img/donut.png';

	// copy the image to the canvas
	$(img).load(function(){
	  canvas.drawImage(img,0,0);
	});

	// http://www.javascripter.net/faq/rgbtohex.htm
	function rgbToHex(R,G,B) {return toHex(R)+toHex(G)+toHex(B)}

  function toHex(n) {
	  n = parseInt(n,10);
	  if (isNaN(n)) return "00";
	  n = Math.max(0,Math.min(n,255));
	  return "0123456789ABCDEF".charAt((n-n%16)/16)  + "0123456789ABCDEF".charAt(n%16);
	}

	/*
	$('#draggable .close').click(function(event){
		$('#draggable').hide();
	});
	*/

	$(document).click(function(event){
		let clickedArea = event.target.id;
		if (clickedArea === "" || clickedArea === "map") {
			$('#draggable').hide();
		}
	});

	$('#draggable').click(function(event){

    // getting user coordinates
	  var x = event.pageX - this.offsetLeft;
	  var y = event.pageY - this.offsetTop;

    // getting image data and RGB values
	  var img_data = canvas.getImageData(x, y, 1, 1).data;
	  var R = img_data[0];
	  var G = img_data[1];
	  var B = img_data[2];

    // convert RGB to HEX
	  var hex = rgbToHex(R,G,B);
		if (hex != "3F3844" && hex != "FFFFFF" && hex != "000000") {
			$(selectedCanton).attr('fill', '#' + hex)
			//$('#color').css("background-color", '#' + hex);
		}
	});

	// Events on every canton
  $('img.svg').each(function(){
  var $img = jQuery(this);
  var imgID = $img.attr('id');
  var imgClass = $img.attr('class');
  var imgURL = $img.attr('src');

    $.get(imgURL, function(data) {
        // Get the SVG tag, ignore the rest
        var $svg = jQuery(data).find('svg');

        // Add replaced image's ID to the new SVG
        if(typeof imgID !== 'undefined') {
            $svg = $svg.attr('id', imgID);
        }
        // Add replaced image's classes to the new SVG
        if(typeof imgClass !== 'undefined') {
            $svg = $svg.attr('class', imgClass+' replaced-svg');
        }

        // Remove any invalid XML tags as per http://validator.w3.org
        $svg = $svg.removeAttr('xmlns:a');

        // Replace image with new SVG
        $img.replaceWith($svg);

        // Add an handler
        $('path').each(function() {
            $(this).click(function() {
              let type = $(this).attr('class');
              if(type == 'canton') {
									selectedCanton = $(this);
									$('#draggable').show();
              }
            });
        });
    });
  });

</script>

</body>
</html>
